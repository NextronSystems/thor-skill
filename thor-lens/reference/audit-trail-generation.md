# Audit Trail Generation

THOR Lens consumes audit trail files generated by THOR v11. This document explains how to generate audit trails for import into THOR Lens.

## Critical Requirement

**THOR v11 is required.** THOR v10 does not produce the audit trail format needed by THOR Lens.

## Basic Audit Trail Command

```bash
./thor-linux-64 --lab -p /target --audit-trail /path/to/output.jsonl
```

The `--audit-trail` flag outputs a JSONL file containing all scanned elements with full metadata.

## Recommended Flags

For best results in THOR Lens, include:

| Flag | Purpose |
|------|---------|
| `--audit-trail <path>` | Enable audit trail output (required) |
| `-j <hostname>` | Preserve original hostname in events |
| `--virtual-map <mount>:<drive>` | Map mounted paths to original paths |
| `--lab` | Enable lab mode for thorough scanning |

## Example Commands

### Live System Scan

```bash
# Windows
thor64.exe --lab -p C:\ --audit-trail C:\cases\host01_audit.jsonl -e C:\cases\reports

# Linux
./thor-linux-64 --lab -p / --audit-trail /cases/host01_audit.jsonl -e /cases/reports
```

### Mounted Forensic Image

```bash
./thor-linux-64 --lab \
  -p /mnt/image \
  --virtual-map /mnt/image:C \
  -j WORKSTATION01 \
  --audit-trail /cases/WORKSTATION01_audit.jsonl \
  -e /cases/reports
```

**Key flags:**
- `--virtual-map /mnt/image:C` - Maps `/mnt/image/Windows/System32` to `C:\Windows\System32` in events
- `-j WORKSTATION01` - Sets hostname in events (otherwise shows the analysis host)

### Mounted Linux Image

```bash
./thor-linux-64 --lab \
  -p /mnt/image \
  --virtual-map /mnt/image:/ \
  -j linuxserver01 \
  --audit-trail /cases/linuxserver01_audit.jsonl \
  -e /cases/reports
```

### SSHFS Remote Scan

For systems that can't run THOR directly:

```bash
# Mount remote system
sshfs root@appliance:/ /mnt/remote -o ro

# Scan with THOR v11
./thor-linux-64 --lab \
  -p /mnt/remote \
  --virtual-map /mnt/remote:/ \
  -j appliance-hostname \
  --audit-trail /cases/appliance_audit.jsonl \
  -e /cases/reports

# Unmount
fusermount -u /mnt/remote
```

### Memory Dump Analysis

```bash
./thor-linux-64 --lab \
  --image_file /cases/memory.dmp \
  -j WORKSTATION01 \
  --audit-trail /cases/WORKSTATION01_mem_audit.jsonl \
  -e /cases/reports
```

## Output File Options

### Plain JSONL

```bash
--audit-trail /cases/output.jsonl
```

### Gzip Compressed

```bash
--audit-trail /cases/output.jsonl.gz
```

Compression recommended for large scans to save disk space.

## Audit Trail Content

The audit trail contains:
- All scanned elements (not just detections)
- Element relationships and references
- Multiple timestamps per element (created, modified, accessed, etc.)
- Full scoring details and reasons
- Object metadata and attributes

## Verifying Audit Trail

### File Exists and Has Content

```bash
ls -lh /cases/output.jsonl
# or
ls -lh /cases/output.jsonl.gz
```

### Verify Gzip Integrity

```bash
gzip -t /cases/output.jsonl.gz && echo "OK"
```

### Preview Content

```bash
# Plain JSONL
head -3 /cases/output.jsonl | jq .

# Gzipped
zcat /cases/output.jsonl.gz | head -3 | jq .
```

### Count Records

```bash
# Plain
wc -l /cases/output.jsonl

# Gzipped
zcat /cases/output.jsonl.gz | wc -l
```

## Sanity Checklist

Before importing to THOR Lens:

- [ ] File exists and is non-empty
- [ ] File is JSONL format (one JSON object per line)
- [ ] If gzipped, `gzip -t` passes
- [ ] First few lines parse as valid JSON
- [ ] Hostname is correct (check `-j` was used for images)
- [ ] Paths are correct (check `--virtual-map` was used for images)

## Common Mistakes

### Wrong THOR Version

```
Problem: Audit trail is empty or malformed
Cause: Used THOR v10 instead of v11
Solution: Use THOR v11 with --audit-trail flag
```

### Missing Virtual Map

```
Problem: All paths show /mnt/image/... instead of C:\...
Cause: Forgot --virtual-map when scanning mounted image
Solution: Re-scan with --virtual-map /mnt/image:C
```

### Missing Hostname

```
Problem: Events show analysis workstation hostname
Cause: Forgot -j flag when scanning image
Solution: Re-scan with -j <original_hostname>
```

### Using Text Log Instead of Audit Trail

```
Problem: Import fails or UI shows nothing
Cause: Imported regular THOR text/JSON log, not audit trail
Solution: Generate audit trail with --audit-trail flag
```

## Audit Trail vs Regular Output

| Feature | Regular Output | Audit Trail |
|---------|---------------|-------------|
| Format | Text/JSON/HTML/CSV | JSONL |
| Content | Detections only | All scanned elements |
| Relationships | Not preserved | Preserved |
| Multiple timestamps | Collapsed | Expanded |
| Use case | Reports, SIEM | THOR Lens analysis |
